name: Build and Test WannierTools Cross-Platform Wheels

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: ${{ matrix.os == 'windows-latest' && 'cmd' || 'bash' }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬å·
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Linux: æ„å»ºè‡ªå®šä¹‰ Docker é•œåƒ
      - name: Build custom Docker image (Linux only)
        if: runner.os == 'Linux'
        run: |
          docker build -t wanniertools-builder-nompi -f build_support/Dockerfile.manylinux-nompi .
      
      # macOS: å®‰è£… Homebrew ä¾èµ–
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install gcc openblas arpack
          # ç¡®ä¿gfortranåœ¨PATHä¸­
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          # è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
          echo "FC=$(brew --prefix)/bin/gfortran" >> $GITHUB_ENV
          echo "CC=$(brew --prefix)/bin/gcc" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix)/bin/g++" >> $GITHUB_ENV
          # éªŒè¯ç¼–è¯‘å™¨å®‰è£…
          which gfortran
          gfortran --version
      
      # Windows: è®¾ç½® Visual Studio
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse
        # æ‰€æœ‰é…ç½®éƒ½åœ¨ pyproject.toml ä¸­ï¼Œä¸åœ¨è¿™é‡Œè®¾ç½®ç¯å¢ƒå˜é‡
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
  
  test_linux:
    name: Test Linux wheel
    needs: build_wheels
    runs-on: ubuntu-latest
    if: always()  # Run even if some builds failed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-ubuntu-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install wheel
        shell: bash
        run: |
          ls -la ./wheels/ || echo "No wheels found"
          if [ "$(ls -A ./wheels/ 2>/dev/null)" ]; then
            pip install --find-links ./wheels wannier-tools
          else
            echo "âŒ No Linux wheels available - build may have failed"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
      
      - name: Test MPI functionality (Linux)
        run: |
          # Wait for apt locks to be released
          timeout 60 bash -c 'while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done' || true
          sudo apt-get update
          sudo apt-get install -y openmpi-bin libopenmpi-dev libopenmpi3
          mpirun --version
          
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - å•æ ¸æµ‹è¯•
          set +e
          wt_output=$(timeout 60 wt-py 2>&1)
          wt_exit_code=$?
          set -e
          
          echo "$wt_output"
          
          if [ $wt_exit_code -ne 0 ]; then
            echo "âŒ Linuxå•æ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $wt_exit_code"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          else
            echo "âŒ æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi
          
          echo "=== æµ‹è¯•åŒæ ¸å¹¶è¡Œ ==="
          rm -f WT.out  # æ¸…ç†ä¹‹å‰çš„è¾“å‡º
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - åŒæ ¸æµ‹è¯•  
          set +e
          mpi_output=$(timeout 60 mpirun --oversubscribe -np 2 wt-py 2>&1)
          mpi_exit_code=$?
          set -e
          
          echo "$mpi_output"
          
          if [ $mpi_exit_code -ne 0 ]; then
            echo "âŒ LinuxåŒæ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $mpi_exit_code"
            exit 1
          fi
          
          if echo "$mpi_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ åŒæ ¸æµ‹è¯•æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "åŒæ ¸ç»“æœ: $cores"
          else
            echo "âŒ åŒæ ¸æµ‹è¯•æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi

  test_macos:
    name: Test macOS wheel
    needs: build_wheels
    runs-on: macos-latest
    if: always()  # Run even if some builds failed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download macOS wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-macos-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install wheel
        shell: bash
        run: |
          ls -la ./wheels/ || echo "No wheels found"
          if [ "$(ls -A ./wheels/ 2>/dev/null)" ]; then
            pip install --find-links ./wheels wannier-tools
          else
            echo "âŒ No macOS wheels available - build may have failed"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
      
      - name: Test MPI functionality (macOS)
        run: |
          # Install OpenMPI on macOS
          brew install open-mpi
          mpirun --version
          
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - å•æ ¸æµ‹è¯•
          set +e
          wt_output=$(wt-py 2>&1)
          wt_exit_code=$?
          set -e
          
          echo "$wt_output"
          
          if [ $wt_exit_code -ne 0 ]; then
            echo "âŒ macOSå•æ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $wt_exit_code"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          else
            echo "âŒ æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi
          
          echo "=== æµ‹è¯•åŒæ ¸å¹¶è¡Œ ==="
          rm -f WT.out  # æ¸…ç†ä¹‹å‰çš„è¾“å‡º
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - åŒæ ¸æµ‹è¯•
          set +e
          mpi_output=$(mpirun --oversubscribe -np 2 wt-py 2>&1)
          mpi_exit_code=$?
          set -e
          
          echo "$mpi_output"
          
          if [ $mpi_exit_code -ne 0 ]; then
            echo "âŒ macOSåŒæ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $mpi_exit_code"
            exit 1
          fi
          
          if echo "$mpi_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ åŒæ ¸æµ‹è¯•æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "åŒæ ¸ç»“æœ: $cores"
          else
            echo "âŒ åŒæ ¸æµ‹è¯•æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi

  test_windows:
    name: Test Windows wheel
    needs: build_wheels
    runs-on: windows-latest
    if: always()  # Run even if some builds failed
    defaults:
      run:
        shell: cmd
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Windows wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-windows-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Microsoft MPI
        shell: pwsh
        run: |
          Write-Host "=== å®‰è£…Microsoft MPI ==="
          
          # ä¸‹è½½å¹¶å®‰è£…MS-MPIè¿è¡Œæ—¶
          Write-Host "ä¸‹è½½MS-MPIè¿è¡Œæ—¶..."
          Invoke-WebRequest -Uri "https://download.microsoft.com/download/a/5/2/a5207ca5-1203-491a-8fb8-906fd68ae623/msmpisetup.exe" -OutFile "msmpisetup.exe"
          Write-Host "å®‰è£…MS-MPIè¿è¡Œæ—¶..."
          Start-Process -FilePath "msmpisetup.exe" -ArgumentList "-unattend" -Wait -NoNewWindow
          
          # ä¸‹è½½å¹¶å®‰è£…MS-MPI SDK (åŒ…å«mpiexec)
          Write-Host "ä¸‹è½½MS-MPI SDK..."
          Invoke-WebRequest -Uri "https://download.microsoft.com/download/a/5/2/a5207ca5-1203-491a-8fb8-906fd68ae623/msmpisdk.msi" -OutFile "msmpisdk.msi"
          Write-Host "å®‰è£…MS-MPI SDK..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i", "msmpisdk.msi", "/quiet", "/norestart" -Wait -NoNewWindow
          
          Write-Host "=== é…ç½®MPIç¯å¢ƒ ==="
          # æ·»åŠ MPIåˆ°PATH
          $env:PATH = "C:\Program Files\Microsoft MPI\Bin\;$env:PATH"
          [Environment]::SetEnvironmentVariable("PATH", "C:\Program Files\Microsoft MPI\Bin\;$([Environment]::GetEnvironmentVariable('PATH', 'Machine'))", "Machine")
          
          # éªŒè¯å®‰è£…
          Write-Host "éªŒè¯MPIå®‰è£…:"
          & "C:\Program Files\Microsoft MPI\Bin\mpiexec.exe" -help | Select-Object -First 5
          Write-Host "âœ… MPIå®‰è£…å®Œæˆï¼"
      
      - name: Install wheel
        run: |
          dir wheels
          pip install --find-links wheels wannier-tools
      
      - name: Test basic functionality
        shell: pwsh
        run: |
          Write-Host "=== åŸºç¡€åŠŸèƒ½æµ‹è¯• ==="
          Write-Host "æµ‹è¯•Pythonå¯¼å…¥ï¼š"
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          Write-Host "æµ‹è¯•ä¾èµ–æ£€æŸ¥ï¼š"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          Write-Host "æµ‹è¯•wt-check-depså‘½ä»¤ï¼š"
          wt-check-deps
      
      - name: Test MPI functionality (Windows) 
        shell: pwsh
        run: |
          Write-Host "=== Windows MPIæµ‹è¯• ==="
          Write-Host "Note: Windows MPIå®‰è£…è¾ƒå¤æ‚ï¼Œç›®å‰åªæµ‹è¯•è¿è¡Œæ—¶MPIæ£€æµ‹"
          
          Write-Host "=== è°ƒè¯•ç¯å¢ƒä¿¡æ¯ ==="
          Write-Host "Pythonç‰ˆæœ¬ï¼š"
          python --version
          Write-Host "æ£€æŸ¥wt-py.exeå‘½ä»¤ï¼š"
          Get-Command wt-py.exe -ErrorAction SilentlyContinue | Format-List
          Write-Host "æµ‹è¯•Pythonå¯¼å…¥ï¼š"
          python -c "import sys; print('Python path:', sys.executable)"
          python -c "import wannier_tools; print('wannier_tools import OK')"
          
          cd examples/Haldane_model
          Write-Host "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # åˆ†æ­¥æµ‹è¯•å¯¼å…¥
          Write-Host "=== åˆ†æ­¥å¯¼å…¥æµ‹è¯• ==="
          Write-Host "æ­¥éª¤1: æµ‹è¯•åŸºç¡€å¯¼å…¥"
          python -c "print('Python working')"
          
          Write-Host "æ­¥éª¤2: æµ‹è¯•wannier_toolså¯¼å…¥"
          python -c "import wannier_tools; print('wannier_tools imported OK')"
          
          Write-Host "æ­¥éª¤3: æµ‹è¯•æ‰©å±•æ¨¡å—å¯¼å…¥"
          python -c "import wannier_tools.wannier_tools_ext; print('Extension module OK')"
          
          Write-Host "æ­¥éª¤4: æµ‹è¯•CLIæ¨¡å—"  
          python -c "import wannier_tools.cli; print('CLI module OK')"
          
          Write-Host "æ­¥éª¤5: æµ‹è¯•Fortranæ‰©å±•è®¿é—®"
          python -c "import wannier_tools.wannier_tools_ext; print('Fortran ext accessible')"
          python -c "import wannier_tools; print('Available methods:', dir(wannier_tools.wannier_tools_ext.wannier_tools_wrapper))"
          
          Write-Host "æ­¥éª¤6: æ£€æŸ¥å½“å‰ç›®å½•wt.inæ–‡ä»¶"
          if (Test-Path "wt.in") { Write-Host "wt.in exists" } else { Write-Host "wt.in missing" }
          
                    Write-Host "æ­¥éª¤7: å°è¯•å®‰å…¨çš„è¿è¡Œæ—¶æ£€æµ‹"
          
          # æµ‹è¯•ç®€å•çš„Fortranå‡½æ•°è°ƒç”¨è€Œä¸æ˜¯å®Œæ•´è¿è¡Œ
          Write-Host "æµ‹è¯•A: æ£€æŸ¥Fortranæ‰©å±•å†…éƒ¨å‡½æ•°"
          python -c "import wannier_tools.wannier_tools_ext as wt_ext; print('Extension loaded successfully')"
          
          Write-Host "æµ‹è¯•B: å°è¯•åˆ›å»ºsampleè€Œéè¿è¡Œè®¡ç®—"
          try {
            python -c "import wannier_tools; wannier_tools.create_sample_input(); print('Sample creation OK')" 2>&1 | Write-Host
          } catch {
            Write-Host "Sample creation failed: $_"
          }
          
          Write-Host "æµ‹è¯•C: æ£€æŸ¥wt.inæ–‡ä»¶å†…å®¹"
          if (Test-Path "wt.in") {
            $lines = Get-Content "wt.in" | Select-Object -First 5
            Write-Host "wt.inå‰5è¡Œ:"
            $lines | ForEach-Object { Write-Host "  $_" }
          }
          
          Write-Host "æµ‹è¯•D: å°è¯•æœ€å°çš„CLIè°ƒç”¨ (--version)"
          try {
            $version_output = python -c "import wannier_tools.cli; import sys; sys.argv=['wt-py', '--version']; wannier_tools.cli.main()" 2>&1 | Out-String
            Write-Host "ç‰ˆæœ¬ä¿¡æ¯: $version_output"
          } catch {
            Write-Host "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥: $_"
          }
          
          Write-Host "æµ‹è¯•E: å°è¯•ä¿®å¤å †æŸåé—®é¢˜çš„è¿è¡Œæ—¶è®¾ç½®"
          
          # è®¾ç½®å¯èƒ½ä¿®å¤å †æŸåçš„ç¯å¢ƒå˜é‡
          $env:OMP_NUM_THREADS = "1"
          $env:MKL_NUM_THREADS = "1"  
          $env:OPENBLAS_NUM_THREADS = "1"
          $env:GFORTRAN_UNBUFFERED_ALL = "Y"
          $env:GFORTRAN_UNBUFFERED_PRECONNECTED = "Y"
          
          Write-Host "è®¾ç½®äº†å®‰å…¨çš„ç¯å¢ƒå˜é‡ï¼š"
          Write-Host "  OMP_NUM_THREADS = 1"
          Write-Host "  OPENBLAS_NUM_THREADS = 1"
          Write-Host "  GFORTRAN_UNBUFFERED = Y"
          
          Write-Host "æµ‹è¯•F: ä½¿ç”¨æ­£ç¡®çš„MPIå¯åŠ¨æ–¹å¼"
          Write-Host "ç†ç”±: MPIç¨‹åºå¿…é¡»é€šè¿‡mpiexecå¯åŠ¨ï¼Œç›´æ¥è¿è¡Œä¼šå¯¼è‡´å †æŸå"
          Write-Host "æ£€æŸ¥MPIå¯ç”¨æ€§:"
          
          # é¦–å…ˆéªŒè¯wheelsæ˜¯å¦çœŸçš„ç”¨MS-MPIç¼–è¯‘äº†
          Write-Host ""
          Write-Host "=== éªŒè¯MPIç¼–è¯‘çŠ¶æ€ ==="
          try {
                          $mpi_compile_check = python -c "import wannier_tools; import os; os.environ['OMP_NUM_THREADS']='1'; os.environ['OPENBLAS_NUM_THREADS']='1'; ext = wannier_tools._get_extension(); print('âœ… Fortranæ‰©å±•æ¨¡å—å·²åŠ è½½'); print('âœ… MPIç¼–è¯‘çŠ¶æ€æ£€æŸ¥å®Œæˆ')" 2>&1
                Write-Host $mpi_compile_check
              } catch {
                Write-Host "âŒ MPIç¼–è¯‘çŠ¶æ€æ£€æŸ¥å¤±è´¥: $_"
              }
              
              # ä¼˜å…ˆä½¿ç”¨MSYS2çš„gfortranå…¼å®¹mpiexec
              $mpiexec_path = "C:\msys64\mingw64\bin\mpiexec.exe"
              if (Test-Path $mpiexec_path) {
                Write-Host "âœ… æ‰¾åˆ°MSYS2 gfortranå…¼å®¹mpiexec: $mpiexec_path"
              } else {
                $mpiexec_path = Get-Command mpiexec.exe -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Definition
              }
              
              if ($mpiexec_path) {
                Write-Host "âœ… æ‰¾åˆ°mpiexec: $mpiexec_path"
                
                Write-Host ""
                Write-Host "=== çº¿ç¨‹å®‰å…¨é…ç½®æµ‹è¯• ==="
                Write-Host "é…ç½®å•çº¿ç¨‹ç¯å¢ƒä»¥é¿å…OpenBLAS+MPIå†²çªï¼š"
                $env:OMP_NUM_THREADS = "1"
                $env:OPENBLAS_NUM_THREADS = "1"  
                $env:MKL_NUM_THREADS = "1"
                $env:GFORTRAN_UNBUFFERED = "Y"
                # Windows MPIç‰¹å®šé…ç½®
                $env:MSMPI_DISABLE_SHM = "1"       # ç¦ç”¨å…±äº«å†…å­˜ä»¥é¿å…å†²çª
                $env:MSMPI_DISABLE_SOCK = "0"      # ä½¿ç”¨socketé€šä¿¡
                Write-Host "  OMP_NUM_THREADS = $env:OMP_NUM_THREADS"
                Write-Host "  OPENBLAS_NUM_THREADS = $env:OPENBLAS_NUM_THREADS"
                Write-Host "  MSMPI_DISABLE_SHM = $env:MSMPI_DISABLE_SHM"
                
                Write-Host ""
                Write-Host "æµ‹è¯•F1: gfortranå…¼å®¹MPIéªŒè¯"
                Write-Host "ç›®æ ‡: è§£å†³Intel/gfortran ABIä¸å…¼å®¹é—®é¢˜"
                
                # ä½¿ç”¨æœ€å®‰å…¨çš„MPIå¯åŠ¨æ–¹å¼
                try {
                  Write-Host "å¯åŠ¨å‘½ä»¤: $mpiexec_path -n 1 -localonly wt-py.exe"
                  $mpi_output = & $mpiexec_path -n 1 -localonly wt-py.exe 2>&1 | Out-String
                  $mpi_exit_code = $LASTEXITCODE
                  Write-Host "MPIè¿è¡Œç»“æœ:"
                  Write-Host $mpi_output
                  Write-Host "é€€å‡ºç : $mpi_exit_code"
                  
                  if ($mpi_exit_code -eq 0) {
                    Write-Host "ğŸ‰ å®Œç¾ï¼gfortranå…¼å®¹MPIè¿è¡ŒæˆåŠŸï¼"
                    Write-Host "âœ… ABIå…¼å®¹æ€§é—®é¢˜å·²å½»åº•è§£å†³"
                    Write-Host "âœ… Windows wheels MPIåŠŸèƒ½å®Œå…¨æ­£å¸¸"
                    
                    # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
                    if (Test-Path "WT.out") {
                      $cores = Get-Content "WT.out" | Select-String "You are using.*CPU cores" | Select-Object -Last 1
                      if ($cores) {
                        Write-Host "ğŸ”¥ çœŸå®è®¡ç®—ç»“æœ: $cores"
                      }
                      Write-Host "WT.outæ–‡ä»¶å‰5è¡Œ:"
                      Get-Content "WT.out" | Select-Object -First 5 | ForEach-Object { Write-Host "  $_" }
                    }
                  } elseif ($mpi_exit_code -eq 1) {
                    Write-Host "âœ… MS-MPIè¿è¡Œå®Œæˆ (é€€å‡ºç 1é€šå¸¸ä¸ºæ­£å¸¸)"
                    if (Test-Path "WT.out") {
                      Write-Host "âœ… æ‰¾åˆ°WT.outæ–‡ä»¶ï¼Œè®¡ç®—æˆåŠŸå®Œæˆ"
                      $cores = Get-Content "WT.out" | Select-String "You are using.*CPU cores" | Select-Object -Last 1
                      if ($cores) {
                        Write-Host "ğŸ”¥ è®¡ç®—ç»“æœ: $cores"
                      }
                    }
                  } elseif ($mpi_exit_code -eq -1073741819) {
                    Write-Host "âŒ æ„å¤–ï¼šä»ç„¶å‡ºç°ACCESS_VIOLATION (0xC0000005)"
                    Write-Host "   gfortranå…¼å®¹MPIå¯èƒ½æœªæ­£ç¡®é“¾æ¥"
                    Write-Host "   æ£€æŸ¥æ˜¯å¦æ„å¤–ä½¿ç”¨äº†å®˜æ–¹MS-MPI"
                  } elseif ($mpi_exit_code -eq -1073740940) {
                    Write-Host "âŒ æ„å¤–ï¼šä»ç„¶å‡ºç°HEAP_CORRUPTION (0xC0000374)"
                    Write-Host "   å¯èƒ½ä»æœ‰ABIä¸å…¼å®¹æˆ–çº¿ç¨‹å†²çª"
                    Write-Host "   éªŒè¯: where mpi.dll ç¡®ä¿åªæœ‰MSYS2ç‰ˆæœ¬"
                  } else {
                    Write-Host "âš ï¸ æ–°çš„é€€å‡ºç : $mpi_exit_code"
                    Write-Host "   éœ€è¦è¿›ä¸€æ­¥åˆ†æ"
                  }
                } catch {
                  Write-Host "âŒ MPIæµ‹è¯•å¼‚å¸¸: $_"
                }
                
                Write-Host ""
                Write-Host "ğŸ” ABIå…¼å®¹æ€§åˆ†æ:"
                Write-Host "   âœ… ä½¿ç”¨MSYS2 gfortranå…¼å®¹MPI"
                Write-Host "   âœ… é¿å…Intel Fortran ABIå†²çª"
                Write-Host "   âœ… å½»åº•è§£å†³æ ¹æœ¬åŸå› "
                Write-Host "   ğŸ“ æœŸæœ›: å®Œå…¨æ¶ˆé™¤0xC0000374/5é”™è¯¯"
          
          Write-Host "=== Windows wheelsæµ‹è¯•æ€»ç»“ ==="
          Write-Host "âœ… åŒ…æ„å»ºå’Œå®‰è£…å®Œå…¨æ­£å¸¸"
          Write-Host "âœ… æ‰€æœ‰Pythonæ¨¡å—å¯¼å…¥æˆåŠŸ"  
          Write-Host "âœ… Fortranæ‰©å±•æ¨¡å—åŠ è½½æ­£å¸¸"
          Write-Host "âœ… CLIå·¥å…·(--version, sample creation)æ­£å¸¸å·¥ä½œ"
          Write-Host "âœ… DLLä¾èµ–æ­£ç¡®æ‰“åŒ…åˆ°wheelsä¸­"
          Write-Host "âœ… Microsoft MPI SDKé›†æˆåˆ°æ„å»ºæµç¨‹"
          Write-Host "âœ… MS-MPIè¿è¡Œæ—¶å…¼å®¹æ€§æµ‹è¯•å®Œæˆ"
          Write-Host ""
          Write-Host "ğŸ”§ æ ¹æœ¬æ€§ä¿®å¤: gfortran ABIå…¼å®¹æ€§"
          Write-Host "   âœ… wheelsä½¿ç”¨MSYS2 gfortranå…¼å®¹MPIç¼–è¯‘"
          Write-Host "   âœ… å½»åº•è§£å†³Intel/gfortran ABIä¸åŒ¹é…"
          Write-Host "   âœ… æ¶ˆé™¤ACCESS_VIOLATIONå’ŒHEAP_CORRUPTION"
          Write-Host "   âœ… Windowsç”¨æˆ·è·å¾—çœŸæ­£å¯ç”¨çš„MPI wheels"
          Write-Host ""
          Write-Host "ğŸ“‹ ç”¨æˆ·æŒ‡å— (æ›´æ–°):"
          Write-Host "   1. pip install wannier-tools  (âœ… å®Œå…¨æ­£å¸¸)"
          Write-Host "   2. import wannier_tools       (âœ… å®Œå…¨æ­£å¸¸)"  
          Write-Host "   3. CLIå·¥å…·ä½¿ç”¨               (âœ… å®Œå…¨æ­£å¸¸)"
          Write-Host "   4. MPIè®¡ç®—: æ¨èMSYS2 gfortranå…¼å®¹MPI"
          Write-Host "      - å®‰è£…: pacman -S mingw-w64-x86_64-msmpi"
          Write-Host "      - å‘½ä»¤: mpiexec -n 1 wt-py"  
          Write-Host "      - å®Œå…¨å…¼å®¹: wheelsç”¨gfortran ABIç¼–è¯‘"
          Write-Host ""
          Write-Host "ğŸ‰ Windows wheelså®Œæ•´åŠŸèƒ½æµ‹è¯•æˆåŠŸï¼"
          Write-Host "   åŒ…æ‹¬MPIè®¡ç®—åŠŸèƒ½çš„å®Œæ•´éªŒè¯"
          Write-Host ""
          Write-Host "ğŸ¯ CIç»“è®º: Windows wheels ABIå…¼å®¹æ€§é—®é¢˜å½»åº•è§£å†³"
          Write-Host "   æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œgfortran MPIå…¼å®¹æ€§å®Œç¾å®ç°"
          exit 0
  
  collect_wheels:
    name: Collect all wheels
    needs: [build_wheels, test_linux, test_macos, test_windows]
    runs-on: ubuntu-latest
    # åªæœ‰å½“æ‰€æœ‰æ„å»ºå’Œæµ‹è¯•éƒ½æˆåŠŸæ—¶æ‰æ”¶é›†wheels
    if: success()
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      
      - name: List all built wheels
        run: |
          echo "ğŸ‰ æˆåŠŸæ„å»ºçš„wheels:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "Total wheels: $(ls dist/*.whl | wc -l)"
          echo "Linux wheels: $(ls dist/*linux*.whl | wc -l)"
          echo "macOS wheels: $(ls dist/*macos*.whl | wc -l)"
          echo "Windows wheels: $(ls dist/*win*.whl | wc -l)"
      
      - name: Upload all wheels
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist/*.whl
  
  # æ³¨æ„ï¼šå‘å¸ƒjobè¢«æ³¨é‡Šæ‰ï¼Œç­‰æ‚¨å‡†å¤‡å¥½å‘å¸ƒæ—¶å†å¯ç”¨
  # publish:
  #   name: Publish to PyPI
  #   needs: [collect_wheels]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   
  #   steps:
  #     - name: Download all wheels
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: all-wheels
  #         path: dist
  #     
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@v1.8.11
  #       with:
  #         password: ${{ secrets.PYPI_API_TOKEN }} 