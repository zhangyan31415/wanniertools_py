name: Build and Test WannierTools Cross-Platform Wheels

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬å·
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Linux: æ„å»ºè‡ªå®šä¹‰ Docker é•œåƒ
      - name: Build custom Docker image (Linux only)
        if: runner.os == 'Linux'
        run: |
          docker build -t wanniertools-builder-nompi -f build_support/Dockerfile.manylinux-nompi .
      
      # macOS: å®‰è£… Homebrew ä¾èµ–
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install gcc openblas arpack
          # ç¡®ä¿gfortranåœ¨PATHä¸­
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          # è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
          echo "FC=$(brew --prefix)/bin/gfortran" >> $GITHUB_ENV
          echo "CC=$(brew --prefix)/bin/gcc" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix)/bin/g++" >> $GITHUB_ENV
          # éªŒè¯ç¼–è¯‘å™¨å®‰è£…
          which gfortran
          gfortran --version
      
      # Windows: è®¾ç½® Visual Studio
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse
        # æ‰€æœ‰é…ç½®éƒ½åœ¨ pyproject.toml ä¸­ï¼Œä¸åœ¨è¿™é‡Œè®¾ç½®ç¯å¢ƒå˜é‡
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
  
  test_linux:
    name: Test Linux wheel
    needs: build_wheels
    runs-on: ubuntu-latest
    if: always()  # Run even if some builds failed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-ubuntu-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install wheel
        shell: bash
        run: |
          ls -la ./wheels/ || echo "No wheels found"
          if [ "$(ls -A ./wheels/ 2>/dev/null)" ]; then
            pip install --find-links ./wheels wannier-tools
          else
            echo "âŒ No Linux wheels available - build may have failed"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
      
      - name: Test MPI functionality (Linux)
        run: |
          # Wait for apt locks to be released
          timeout 60 bash -c 'while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done' || true
          sudo apt-get update
          sudo apt-get install -y openmpi-bin libopenmpi-dev libopenmpi3
          mpirun --version
          
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - å•æ ¸æµ‹è¯•
          set +e
          wt_output=$(timeout 60 wt-py 2>&1)
          wt_exit_code=$?
          set -e
          
          echo "$wt_output"
          
          if [ $wt_exit_code -ne 0 ]; then
            echo "âŒ Linuxå•æ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $wt_exit_code"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          else
            echo "âŒ æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi
          
          echo "=== æµ‹è¯•åŒæ ¸å¹¶è¡Œ ==="
          rm -f WT.out  # æ¸…ç†ä¹‹å‰çš„è¾“å‡º
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - åŒæ ¸æµ‹è¯•  
          set +e
          mpi_output=$(timeout 60 mpirun --oversubscribe -np 2 wt-py 2>&1)
          mpi_exit_code=$?
          set -e
          
          echo "$mpi_output"
          
          if [ $mpi_exit_code -ne 0 ]; then
            echo "âŒ LinuxåŒæ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $mpi_exit_code"
            exit 1
          fi
          
          if echo "$mpi_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ åŒæ ¸æµ‹è¯•æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "åŒæ ¸ç»“æœ: $cores"
          else
            echo "âŒ åŒæ ¸æµ‹è¯•æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi

  test_macos:
    name: Test macOS wheel
    needs: build_wheels
    runs-on: macos-latest
    if: always()  # Run even if some builds failed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download macOS wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-macos-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install wheel
        shell: bash
        run: |
          ls -la ./wheels/ || echo "No wheels found"
          if [ "$(ls -A ./wheels/ 2>/dev/null)" ]; then
            pip install --find-links ./wheels wannier-tools
          else
            echo "âŒ No macOS wheels available - build may have failed"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
      
      - name: Test MPI functionality (macOS)
        run: |
          # Install OpenMPI on macOS
          brew install open-mpi
          mpirun --version
          
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - å•æ ¸æµ‹è¯•
          set +e
          wt_output=$(wt-py 2>&1)
          wt_exit_code=$?
          set -e
          
          echo "$wt_output"
          
          if [ $wt_exit_code -ne 0 ]; then
            echo "âŒ macOSå•æ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $wt_exit_code"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          else
            echo "âŒ æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi
          
          echo "=== æµ‹è¯•åŒæ ¸å¹¶è¡Œ ==="
          rm -f WT.out  # æ¸…ç†ä¹‹å‰çš„è¾“å‡º
          
          # å¼ºåŒ–é”™è¯¯æ£€æµ‹ - åŒæ ¸æµ‹è¯•
          set +e
          mpi_output=$(mpirun --oversubscribe -np 2 wt-py 2>&1)
          mpi_exit_code=$?
          set -e
          
          echo "$mpi_output"
          
          if [ $mpi_exit_code -ne 0 ]; then
            echo "âŒ macOSåŒæ ¸æµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $mpi_exit_code"
            exit 1
          fi
          
          if echo "$mpi_output" | grep -q "FATAL\|ERROR\|Could not import"; then
            echo "âŒ åŒæ ¸æµ‹è¯•æ£€æµ‹åˆ°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "åŒæ ¸ç»“æœ: $cores"
          else
            echo "âŒ åŒæ ¸æµ‹è¯•æœªç”ŸæˆWT.outæ–‡ä»¶"
            exit 1
          fi

  test_windows:
    name: Test Windows wheel
    needs: build_wheels
    runs-on: windows-latest
    if: always()  # Run even if some builds failed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Windows wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-windows-latest
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install wheel
        shell: bash
        run: |
          ls -la ./wheels/ || echo "No wheels found"
          if [ "$(ls -A ./wheels/ 2>/dev/null)" ]; then
            pip install --find-links ./wheels wannier-tools
          else
            echo "âŒ No Windows wheels available - build may have failed"
            exit 1
          fi
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'[OK] wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
      
      - name: Test MPI functionality (Windows) 
        shell: bash
        run: |
          echo "=== Windows MPIæµ‹è¯• ==="
          echo "Note: Windows MPIå®‰è£…è¾ƒå¤æ‚ï¼Œç›®å‰åªæµ‹è¯•è¿è¡Œæ—¶MPIæ£€æµ‹"
          
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          
          # æ•è·wt-pyçš„è¾“å‡ºå’Œé€€å‡ºç 
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥è€Œä¸é€€å‡ºè„šæœ¬
          wt_output=$(wt-py 2>&1)
          wt_exit_code=$?
          set -e  # é‡æ–°å¯ç”¨é”™è¯¯æ—¶é€€å‡º
          
          echo "$wt_output"  # æ˜¾ç¤ºå®Œæ•´è¾“å‡º
          
          # æ£€æŸ¥å¤šç§å¤±è´¥æ¡ä»¶
          if [ $wt_exit_code -ne 0 ]; then
            echo "âŒ wt-pyå‘½ä»¤è¿”å›é”™è¯¯é€€å‡ºç : $wt_exit_code"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "FATAL"; then
            echo "âŒ æ£€æµ‹åˆ°FATALé”™è¯¯"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "DLL load failed"; then
            echo "âŒ æ£€æµ‹åˆ°DLLåŠ è½½é”™è¯¯"
            exit 1
          fi
          
          if echo "$wt_output" | grep -q "Could not import"; then
            echo "âŒ æ£€æµ‹åˆ°å¯¼å…¥é”™è¯¯"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†WT.outæ–‡ä»¶
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          else
            echo "âŒ æœªç”ŸæˆWT.outæ–‡ä»¶ï¼Œè¯´æ˜wt-pyå®é™…æœªæˆåŠŸè¿è¡Œ"
            exit 1
          fi
          
          echo "=== Windowsæš‚æ—¶è·³è¿‡å¤šæ ¸æµ‹è¯•ï¼ˆéœ€è¦MS-MPIå®‰è£…ï¼‰ ==="
  
  collect_wheels:
    name: Collect all wheels
    needs: [build_wheels, test_linux, test_macos, test_windows]
    runs-on: ubuntu-latest
    # åªæœ‰å½“æ‰€æœ‰æ„å»ºå’Œæµ‹è¯•éƒ½æˆåŠŸæ—¶æ‰æ”¶é›†wheels
    if: success()
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      
      - name: List all built wheels
        run: |
          echo "ğŸ‰ æˆåŠŸæ„å»ºçš„wheels:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "Total wheels: $(ls dist/*.whl | wc -l)"
          echo "Linux wheels: $(ls dist/*linux*.whl | wc -l)"
          echo "macOS wheels: $(ls dist/*macos*.whl | wc -l)"
          echo "Windows wheels: $(ls dist/*win*.whl | wc -l)"
      
      - name: Upload all wheels
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist/*.whl
  
  # æ³¨æ„ï¼šå‘å¸ƒjobè¢«æ³¨é‡Šæ‰ï¼Œç­‰æ‚¨å‡†å¤‡å¥½å‘å¸ƒæ—¶å†å¯ç”¨
  # publish:
  #   name: Publish to PyPI
  #   needs: [collect_wheels]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   
  #   steps:
  #     - name: Download all wheels
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: all-wheels
  #         path: dist
  #     
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@v1.8.11
  #       with:
  #         password: ${{ secrets.PYPI_API_TOKEN }} 