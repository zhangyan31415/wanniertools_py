name: Build and Test WannierTools Cross-Platform Wheels

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬å·
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # Linux: æ„å»ºè‡ªå®šä¹‰ Docker é•œåƒ
      - name: Build custom Docker image (Linux only)
        if: runner.os == 'Linux'
        run: |
          docker build -t wanniertools-builder-nompi -f build_support/Dockerfile.manylinux-nompi .
      
      # macOS: å®‰è£… Homebrew ä¾èµ–
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install gcc openblas arpack
      
      # Windows: è®¾ç½® Visual Studio
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.2
        env:
          # æ„å»ºè®¾ç½® - æ”¯æŒPython 3.8-3.12
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          CIBW_SKIP: "pp* *musllinux*"
          
          # ç¯å¢ƒå˜é‡
          CIBW_ENVIRONMENT: >
            FFLAGS="-fallow-invalid-boz -fbackslash -ffree-line-length-none -fallow-argument-mismatch"
          
          # Linux ç‰¹å®šé…ç½®
          CIBW_MANYLINUX_X86_64_IMAGE: wanniertools-builder-nompi
          CIBW_BEFORE_BUILD_LINUX: |
            echo "Building manylinux wheels with runtime MPI detection"
            echo "Available Python versions:"
            ls /opt/python/
          
          # macOS ç‰¹å®šé…ç½®
          CIBW_ENVIRONMENT_MACOS: >
            FFLAGS="-fallow-invalid-boz -fbackslash -ffree-line-length-none -fallow-argument-mismatch"
            PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig"
            LDFLAGS="-L$(brew --prefix)/lib -Wl,-rpath,$(brew --prefix)/lib"
            CPPFLAGS="-I$(brew --prefix)/include"
          CIBW_BEFORE_BUILD_MACOS: |
            echo "Building macOS wheels with runtime MPI detection"
            echo "Homebrew prefix: $(brew --prefix)"
            echo "Available libraries:"
            ls -la "$(brew --prefix)/lib/" | grep -E "(blas|arpack)" || true
          
          # Windows ç‰¹å®šé…ç½®
          CIBW_BEFORE_BUILD_WINDOWS: |
            echo "Building Windows wheels with runtime MPI detection"
            echo "Python version: %CIBW_BUILD%"
          
          # æµ‹è¯•é…ç½®
          CIBW_TEST_COMMAND: |
            python -c "import wannier_tools; print('âœ… Import successful')"
            python -c "import wannier_tools; print('Version:', wannier_tools.__version__)"
            python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()" || echo "Dependency check completed"
          
          # æ¶æ„è®¾ç½®
          CIBW_ARCHS_LINUX: x86_64
          CIBW_ARCHS_MACOS: x86_64 arm64
          CIBW_ARCHS_WINDOWS: AMD64
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
  
  test_installation:
    name: Test wheel installation
    needs: build_wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download wheels for ${{ matrix.os }}
        uses: actions/download-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheels
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install wheel
        run: |
          pip install --find-links ./wheels wannier-tools
      
      - name: Test basic functionality
        run: |
          python -c "import wannier_tools; print(f'âœ… wannier_tools {wannier_tools.__version__} imported successfully')"
          python -c "import wannier_tools.check_deps; wannier_tools.check_deps.main()"
          wt-check-deps
  
  test_mpi_functionality:
    name: Test MPI functionality (Linux)
    needs: build_wheels
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-ubuntu-latest
          path: ./wheels
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install MPI for testing
        run: |
          sudo apt-get update
          sudo apt-get install -y openmpi-bin openmpi-dev libopenmpi3
          mpirun --version
      
      - name: Install wheel
        run: |
          pip install --find-links ./wheels wannier-tools
      
      - name: Test MPI functionality
        run: |
          cd examples/Haldane_model
          echo "=== æµ‹è¯•å•æ ¸è¿è¡Œ ==="
          timeout 60 wt-py || echo "å•æ ¸æµ‹è¯•å®Œæˆ(timeout)"
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "å•æ ¸ç»“æœ: $cores"
          fi
          
          echo "=== æµ‹è¯•åŒæ ¸å¹¶è¡Œ ==="
          rm -f WT.out  # æ¸…ç†ä¹‹å‰çš„è¾“å‡º
          timeout 60 mpirun -np 2 wt-py || echo "åŒæ ¸æµ‹è¯•å®Œæˆ(timeout)"
          if [ -f WT.out ]; then
            cores=$(grep "CPU cores" WT.out | tail -1 || echo "æœªæ‰¾åˆ°CPU coresä¿¡æ¯")
            echo "åŒæ ¸ç»“æœ: $cores"
          fi
  
  collect_wheels:
    name: Collect all wheels
    needs: [build_wheels, test_installation]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      
      - name: List all built wheels
        run: |
          echo "ğŸ‰ æˆåŠŸæ„å»ºçš„wheels:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "Total wheels: $(ls dist/*.whl | wc -l)"
          echo "Linux wheels: $(ls dist/*linux*.whl | wc -l)"
          echo "macOS wheels: $(ls dist/*macos*.whl | wc -l)"
          echo "Windows wheels: $(ls dist/*win*.whl | wc -l)"
      
      - name: Upload all wheels
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist/*.whl
  
  # æ³¨æ„ï¼šå‘å¸ƒjobè¢«æ³¨é‡Šæ‰ï¼Œç­‰æ‚¨å‡†å¤‡å¥½å‘å¸ƒæ—¶å†å¯ç”¨
  # publish:
  #   name: Publish to PyPI
  #   needs: [collect_wheels]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
  #   
  #   steps:
  #     - name: Download all wheels
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: all-wheels
  #         path: dist
  #     
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@v1.8.11
  #       with:
  #         password: ${{ secrets.PYPI_API_TOKEN }} 