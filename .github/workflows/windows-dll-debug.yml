name: Windows DLLå†²çªæ£€æµ‹ä¸è°ƒè¯•

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'è°ƒè¯•çº§åˆ«'
        required: false
        default: 'standard'
        type: choice
        options:
        - standard
        - detailed
        - full

env:
  PYTHONFAULTHANDLER: 1
  PYTHONDEVMODE: 1
  CIBUILDWHEEL_BUILD: cp39-win_amd64

jobs:
  windows-dll-analysis:
    name: Windows DLLå†²çªåˆ†æ
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
        architecture: ["x64"]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}
        
    - name: è®¾ç½®MSYS2ç¯å¢ƒ
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc-fortran
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-openblas
          mingw-w64-x86_64-lapack
          mingw-w64-x86_64-arpack
          mingw-w64-x86_64-ninja
          
    - name: æ·»åŠ MSYS2åˆ°PATH
      run: |
        echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH
        echo "C:\msys64\usr\bin" >> $GITHUB_PATH
      shell: bash
      
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
        pip install meson ninja meson-python
        pip install numpy>=2.0.0
        
    - name: æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ
      run: |
        Write-Host "=== ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥ ===" -ForegroundColor Cyan
        Write-Host "Pythonç‰ˆæœ¬:" (python --version)
        Write-Host "GCCç‰ˆæœ¬:" (gcc --version | Select-Object -First 1)
        Write-Host "Gfortranç‰ˆæœ¬:" (gfortran --version | Select-Object -First 1)
        Write-Host "PATHç¯å¢ƒå˜é‡å‰10ä¸ªç›®å½•:"
        $env:PATH -split ';' | Select-Object -First 10 | ForEach-Object { Write-Host "  $_" }
        
        Write-Host "`n=== å…³é”®DLLæ£€æŸ¥ ===" -ForegroundColor Cyan
        $criticalDlls = @("libgfortran-5.dll", "libgcc_s_seh-1.dll", "libwinpthread-1.dll", "libopenblas.dll")
        foreach ($dll in $criticalDlls) {
            $found = where.exe $dll 2>$null
            if ($found) {
                Write-Host "âœ“ $dll -> $found" -ForegroundColor Green
            } else {
                Write-Host "? $dll æœªæ‰¾åˆ°" -ForegroundColor Yellow
            }
        }
      shell: pwsh
      
    - name: æ„å»ºwannier-tools
      run: |
        Write-Host "=== å¼€å§‹æ„å»ºwannier-tools ===" -ForegroundColor Cyan
        
        $env:FC = "gfortran"
        $env:CC = "gcc" 
        $env:CXX = "g++"
        
        try {
            pip install . --no-cache-dir -v
            Write-Host "âœ“ æ„å»ºæˆåŠŸ" -ForegroundColor Green
        } catch {
            Write-Host "âŒ æ„å»ºå¤±è´¥" -ForegroundColor Red
            throw
        }
      shell: pwsh
      
    - name: è¿è¡ŒDLLå†²çªæ£€æµ‹
      run: |
        Write-Host "=== è¿è¡ŒPython DLLå†²çªæ£€æµ‹å™¨ ===" -ForegroundColor Cyan
        python debug_dll_conflicts.py
      shell: pwsh
      continue-on-error: true
      
    - name: è¿è¡ŒDLLä¾èµ–æ£€æŸ¥
      run: |
        Write-Host "=== è¿è¡ŒPowerShell DLLä¾èµ–æ£€æŸ¥å™¨ ===" -ForegroundColor Cyan
        $detailFlag = if ("${{ github.event.inputs.debug_level }}" -eq "detailed") { "-Detailed" } else { "" }
        $saveFlag = "-SaveReport"
        
        if ($detailFlag) {
            powershell -ExecutionPolicy Bypass -File check_dll_deps.ps1 $detailFlag $saveFlag
        } else {
            powershell -ExecutionPolicy Bypass -File check_dll_deps.ps1 $saveFlag
        }
      shell: pwsh
      continue-on-error: true
      
    - name: æµ‹è¯•wannier-toolsåŸºæœ¬åŠŸèƒ½
      run: |
        Write-Host "=== æµ‹è¯•wannier-toolsåŸºæœ¬åŠŸèƒ½ ===" -ForegroundColor Cyan
        
        # åˆ›å»ºæµ‹è¯•è¾“å…¥æ–‡ä»¶
        $testContent = @'
        &CONTROL
        BulkBand_calc = T
        /
        
        &SYSTEM
        NSLAB = 10
        NumOccupied = 18
        SOC = 1
        E_FERMI = 6.6556
        Bmin= -1.0, Bmax= 1.0, Nk1=50
        /
        
        &PARAMETERS
        Eta_Arc = 0.001
        /
        
        LATTICE
        Angstrom
           2.69   0.00   0.00
           0.00   2.69   0.00
           0.00   0.00  10.00
        
        ATOM_POSITIONS
        2
        Direct
        C   0.33333   0.66667   0.50000
        C   0.66667   0.33333   0.50000
        
        PROJECTORS
        2
        C px py pz
        C px py pz
        
        SURFACE
        1 0 0
        0 1 0
        '@
        
        $testContent | Out-File -FilePath "wt_test.in" -Encoding ASCII
        
        # æµ‹è¯•å¯¼å…¥
        try {
            python -c "import wannier_tools; print('wannier_toolså¯¼å…¥æˆåŠŸ')"
        } catch {
            Write-Host "wannier_toolså¯¼å…¥å¤±è´¥" -ForegroundColor Red
        }
        
        # æµ‹è¯•å‘½ä»¤è¡Œå·¥å…·
        try {
            $process = Start-Process -FilePath "wt-py.exe" -ArgumentList "" -RedirectStandardInput "wt_test.in" -RedirectStandardOutput "stdout.txt" -RedirectStandardError "stderr.txt" -Wait -PassThru -NoNewWindow
            
            $exitCode = $process.ExitCode
            $stdout = Get-Content "stdout.txt" -Raw -ErrorAction SilentlyContinue
            $stderr = Get-Content "stderr.txt" -Raw -ErrorAction SilentlyContinue
            
            Write-Host "è¿›ç¨‹é€€å‡ºç  $exitCode"
            
            if ($exitCode -eq 0) {
                Write-Host "wt-py.exe è¿è¡ŒæˆåŠŸ" -ForegroundColor Green
            } elseif ($exitCode -eq -1073740940) {
                Write-Host "ç¡®è®¤å †æŸåé”™è¯¯ 0xC0000374" -ForegroundColor Red
                Write-Host "æ ‡å‡†è¾“å‡º $stdout"
                Write-Host "æ ‡å‡†é”™è¯¯ $stderr"
            } else {
                Write-Host "wt-py.exe å¼‚å¸¸é€€å‡º ä»£ç  $exitCode" -ForegroundColor Yellow
                Write-Host "æ ‡å‡†è¾“å‡º $stdout"
                Write-Host "æ ‡å‡†é”™è¯¯ $stderr"
            }
            
            echo "EXIT_CODE=$exitCode" >> $env:GITHUB_OUTPUT
            
        } catch {
            Write-Host "è¿è¡Œwt-py.exeå¤±è´¥" -ForegroundColor Red
            echo "EXIT_CODE=ERROR" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
      id: test-wt
      
    - name: æ”¶é›†è°ƒè¯•ä¿¡æ¯
      if: always()
      run: |
        Write-Host "=== æ”¶é›†è°ƒè¯•ä¿¡æ¯ ===" -ForegroundColor Cyan
        
        if (Test-Path "WT.out") {
            Write-Host "âœ“ æ‰¾åˆ° WT.out æ–‡ä»¶"
            Get-Content "WT.out" | Select-Object -Last 20 | ForEach-Object { Write-Host "  $_" }
        }
        
        try {
            $events = Get-WinEvent -FilterHashtable @{LogName='Application'; Level=2; StartTime=(Get-Date).AddMinutes(-10)} -ErrorAction SilentlyContinue
            if ($events) {
                Write-Host "`nâš ï¸  å‘ç°æœ€è¿‘çš„åº”ç”¨ç¨‹åºé”™è¯¯äº‹ä»¶:" -ForegroundColor Yellow
                $events | Select-Object -First 5 | ForEach-Object {
                    Write-Host "  æ—¶é—´: $($_.TimeCreated), ID: $($_.Id), æ¶ˆæ¯: $($_.LevelDisplayName)"
                }
            }
        } catch {
            Write-Host "æ— æ³•è®¿é—®äº‹ä»¶æ—¥å¿—" -ForegroundColor Gray
        }
        
        $report = @{
            timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            python_version = python --version
            exit_code = "${{ steps.test-wt.outputs.EXIT_CODE }}"
            os_info = Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
            path_dirs = ($env:PATH -split ';')[0..9]
        }
        
        $report | ConvertTo-Json -Depth 3 | Out-File -FilePath "debug_report.json"
      shell: pwsh
      
    - name: ä¸Šä¼ è°ƒè¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dll-debug-reports-py${{ matrix.python-version }}
        path: |
          dll_conflict_report.json
          dll_check_report_*.txt
          debug_report.json
          WT.out
          stdout.txt
          stderr.txt
        retention-days: 30
        
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-py${{ matrix.python-version }}
        path: |
          build/
          *.log
        retention-days: 7

  analyze-results:
    name: åˆ†æç»“æœå¹¶ç”ŸæˆæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: windows-dll-analysis
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰è°ƒè¯•æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        pattern: dll-debug-reports-*
        merge-multiple: true
        path: reports/
        
    - name: åˆ†æç»“æœ
      run: |
        echo "## ğŸ” Windows DLLå†²çªæ£€æµ‹ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "reports" ] && [ "$(ls -A reports/)" ]; then
          echo "### ğŸ“‹ æ£€æµ‹åˆ°çš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
          ls -la reports/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for report in reports/debug_report.json; do
            if [ -f "$report" ]; then
              echo "### ğŸ“Š æµ‹è¯•ç»“æœ:" >> $GITHUB_STEP_SUMMARY
              exit_code=$(jq -r '.exit_code // "unknown"' "$report")
              python_version=$(jq -r '.python_version // "unknown"' "$report")
              
              echo "- Pythonç‰ˆæœ¬: $python_version" >> $GITHUB_STEP_SUMMARY
              echo "- é€€å‡ºç : $exit_code" >> $GITHUB_STEP_SUMMARY
              
              if [ "$exit_code" = "-1073740940" ]; then
                echo "- âŒ **ç¡®è®¤å­˜åœ¨å †æŸåé—®é¢˜ (0xC0000374)**" >> $GITHUB_STEP_SUMMARY
              elif [ "$exit_code" = "0" ]; then
                echo "- âœ… **ç¨‹åºæ­£å¸¸è¿è¡Œ**" >> $GITHUB_STEP_SUMMARY
              else
                echo "- âš ï¸ **ç¨‹åºå¼‚å¸¸é€€å‡º**" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ -f "reports/dll_conflict_report.json" ]; then
            echo "### ğŸ”§ DLLå†²çªåˆ†æ:" >> $GITHUB_STEP_SUMMARY
            conflicts=$(jq '.conflicts | length' reports/dll_conflict_report.json 2>/dev/null || echo "0")
            echo "- æ£€æµ‹åˆ° $conflicts ä¸ªDLLå†²çª" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
        else
          echo "âŒ æœªæ‰¾åˆ°è°ƒè¯•æŠ¥å‘Šæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ğŸ’¡ å»ºè®®:" >> $GITHUB_STEP_SUMMARY
        echo "1. æŸ¥çœ‹ä¸Šä¼ çš„è°ƒè¯•æŠ¥å‘Šæ–‡ä»¶è·å–è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "2. å¦‚æœå‘ç°DLLå†²çªï¼Œè¯·æ¸…ç†PATHç¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
        echo "3. è€ƒè™‘ä½¿ç”¨é™æ€é“¾æ¥ç‰ˆæœ¬é‡æ–°æ„å»º" >> $GITHUB_STEP_SUMMARY
        echo "4. å‚è€ƒ [DLL_DEBUGGING_README.md](./DLL_DEBUGGING_README.md) è·å–è¯¦ç»†æŒ‡å¯¼" >> $GITHUB_STEP_SUMMARY
      shell: bash
      
    - name: åˆ›å»ºIssue (å¦‚æœæ£€æµ‹åˆ°é—®é¢˜)
      if: contains(needs.windows-dll-analysis.result, 'failure')
      uses: actions/github-script@v7
      with:
        script: |
          const title = `Windows DLLå†²çªæ£€æµ‹å‘ç°é—®é¢˜ - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## ğŸ” è‡ªåŠ¨æ£€æµ‹åˆ°Windows DLLé—®é¢˜
          
          **æ£€æµ‹æ—¶é—´**: ${new Date().toISOString()}
          **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          **åˆ†æ”¯**: ${{ github.ref }}
          **æäº¤**: ${{ github.sha }}
          
          ### ğŸ“‹ é—®é¢˜æ‘˜è¦
          Windows DLLå†²çªæ£€æµ‹å·¥ä½œæµå‘ç°äº†æ½œåœ¨é—®é¢˜ã€‚è¯·æŸ¥çœ‹ä»¥ä¸‹è°ƒè¯•æŠ¥å‘Šï¼š
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [è°ƒè¯•å·¥å…·ä½¿ç”¨æŒ‡å—](./DLL_DEBUGGING_README.md)
          
          ### ğŸ“ è°ƒè¯•æŠ¥å‘Š
          è¯·ä¸‹è½½å¹¶æŸ¥çœ‹å·¥ä½œæµä¸­ä¸Šä¼ çš„è°ƒè¯•æŠ¥å‘Šæ–‡ä»¶ï¼š
          - \`dll_conflict_report.json\` - è¯¦ç»†çš„DLLå†²çªåˆ†æ
          - \`dll_check_report_*.txt\` - PowerShellæ£€æŸ¥æŠ¥å‘Š
          - \`debug_report.json\` - ç¯å¢ƒä¿¡æ¯æŠ¥å‘Š
          
          ### ğŸ› ï¸ å»ºè®®çš„ä¿®å¤æ­¥éª¤
          1. æ£€æŸ¥PATHç¯å¢ƒå˜é‡ä¸­çš„DLLå†²çª
          2. éªŒè¯MSYS2/MinGW64å·¥å…·é“¾é…ç½®
          3. è€ƒè™‘é‡æ–°æ„å»ºä½¿ç”¨é™æ€é“¾æ¥
          4. è¿è¡Œæœ¬åœ°è°ƒè¯•å·¥å…·è¿›è¡Œè¿›ä¸€æ­¥åˆ†æ
          
          /label bug windows dll-conflict
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'windows', 'dll-conflict', 'auto-generated']
          }); 